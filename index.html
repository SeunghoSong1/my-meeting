<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalMeet AI - Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome & Google Fonts (Inter) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React Imports -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }
        
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .glass-bar {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-white h-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';

        function App() {
            const [mode, setMode] = useState('welcome');
            const [myId, setMyId] = useState('');
            const [targetId, setTargetId] = useState('');
            const [status, setStatus] = useState('ì„œë²„ ì—°ê²° ì¤‘...'); 
            const [isServerConnected, setIsServerConnected] = useState(false); 
            const [showSettings, setShowSettings] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [retryCount, setRetryCount] = useState(0); 
            const [isVideoLoading, setIsVideoLoading] = useState(true);

            // [ìˆ˜ì •] ìƒì„¸ ì§„ë‹¨ ì •ë³´ ìƒíƒœ (ICE ìƒíƒœ ì¶”ê°€)
            const [mediaStatus, setMediaStatus] = useState({
                localVideo: 'ì—†ìŒ',
                localAudio: 'ì—†ìŒ',
                remoteVideo: 'ëŒ€ê¸°ì¤‘',
                remoteAudio: 'ëŒ€ê¸°ì¤‘',
                iceStatus: 'ëŒ€ê¸°ì¤‘ (New)' // ICE ì—°ê²° ìƒíƒœ
            });
            const [showDiagnostics, setShowDiagnostics] = useState(false);

            const [localStream, setLocalStream] = useState(null);
            const [remoteStream, setRemoteStream] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [isVideoOff, setIsVideoOff] = useState(false);
            const [isTtsEnabled, setIsTtsEnabled] = useState(true);
            const [subtitles, setSubtitles] = useState([]);
            const [myLang, setMyLang] = useState('ko');
            
            // AI & Network Settings
            const [geminiKey, setGeminiKey] = useState('');
            const [turnConfig, setTurnConfig] = useState({ url: '', username: '', credential: '' });
            const [summaryText, setSummaryText] = useState('');
            const [isSummarizing, setIsSummarizing] = useState(false);

            const localVideoRef = useRef(null);
            const remoteVideoRef = useRef(null);
            const previewVideoRef = useRef(null);
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const callRef = useRef(null);
            const recognitionRef = useRef(null);
            const geminiKeyRef = useRef('');

            // --- 0. Init ---
            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) { setGeminiKey(savedKey); geminiKeyRef.current = savedKey; }
                
                const savedTurn = localStorage.getItem('turn_config');
                if (savedTurn) setTurnConfig(JSON.parse(savedTurn));
            }, []);

            // [ìˆ˜ì •] ë¯¸ë””ì–´ íŠ¸ë™ ë° ICE ìƒíƒœ ëª¨ë‹ˆí„°ë§
            useEffect(() => {
                const checkInterval = setInterval(() => {
                    const status = {
                        localVideo: 'ì—†ìŒ', localAudio: 'ì—†ìŒ',
                        remoteVideo: 'ëŒ€ê¸°ì¤‘', remoteAudio: 'ëŒ€ê¸°ì¤‘',
                        iceStatus: mediaStatus.iceStatus // ê¸°ì¡´ ê°’ ìœ ì§€
                    };

                    if (localStream) {
                        const vTrack = localStream.getVideoTracks()[0];
                        const aTrack = localStream.getAudioTracks()[0];
                        status.localVideo = vTrack ? (vTrack.enabled ? 'ì •ìƒ (ì†¡ì¶œì¤‘)' : 'êº¼ì§ (Muted)') : 'íŠ¸ë™ ì—†ìŒ';
                        status.localAudio = aTrack ? (aTrack.enabled ? 'ì •ìƒ (ì†¡ì¶œì¤‘)' : 'êº¼ì§ (Muted)') : 'íŠ¸ë™ ì—†ìŒ';
                    }

                    if (remoteStream) {
                        const vTrack = remoteStream.getVideoTracks()[0];
                        const aTrack = remoteStream.getAudioTracks()[0];
                        status.remoteVideo = vTrack ? (vTrack.enabled && vTrack.readyState === 'live' ? 'ìˆ˜ì‹ ì¤‘ (Live)' : `ë¹„ì •ìƒ (${vTrack.readyState})`) : 'íŠ¸ë™ ì—†ìŒ';
                        status.remoteAudio = aTrack ? (aTrack.enabled ? 'ìˆ˜ì‹ ì¤‘' : 'ìƒëŒ€ë°©ì´ ë”') : 'íŠ¸ë™ ì—†ìŒ';
                        
                        if (vTrack && vTrack.readyState === 'live' && !vTrack.muted) {
                            setIsVideoLoading(false);
                        }
                    }
                    
                    // ICE ìƒíƒœ ì—…ë°ì´íŠ¸ (WebRTC ë‚´ë¶€ ìƒíƒœ)
                    if (callRef.current && callRef.current.peerConnection) {
                        status.iceStatus = callRef.current.peerConnection.iceConnectionState;
                    }

                    setMediaStatus(status);
                }, 1000);

                return () => clearInterval(checkInterval);
            }, [localStream, remoteStream]);

            // Cleanup logic
            const stopEverything = () => {
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });
                }
                if (peerRef.current) {
                    peerRef.current.destroy();
                }
                console.log("Cleanup complete");
            };

            useEffect(() => {
                const handleBeforeUnload = () => stopEverything();
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => {
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    stopEverything();
                };
            }, [localStream]);

            const saveSettings = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const key = formData.get('apiKey');
                localStorage.setItem('gemini_api_key', key);
                setGeminiKey(key);
                geminiKeyRef.current = key;

                const turnData = {
                    url: formData.get('turnUrl'),
                    username: formData.get('turnUser'),
                    credential: formData.get('turnPass')
                };
                localStorage.setItem('turn_config', JSON.stringify(turnData));
                setTurnConfig(turnData);

                setShowSettings(false);
                alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.reload();
            };

            // --- 1. Gemini API ---
            const translateWithGemini = async (text, targetLang) => {
                const apiKey = geminiKeyRef.current;
                if (!apiKey) return new Promise(r => setTimeout(() => r(`[No Key]: ${text}`), 300));
                
                const target = targetLang === 'ko' ? 'Korean' : 'English';
                const prompt = `Translate to natural ${target}. Output ONLY text.\n"${text}"`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || text;
                } catch (e) { return text; }
            };

            const generateSummary = async () => {
                const apiKey = geminiKeyRef.current;
                if (!apiKey) return alert("Gemini API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                if (subtitles.length === 0) return alert("ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                setIsSummarizing(true); setShowSummary(true);
                
                const transcript = subtitles.map(s => `- ${s.original} (${s.translated})`).join('\n');
                const prompt = `Summarize this meeting transcript in ${myLang === 'ko' ? 'Korean' : 'English'}:\n${transcript}`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    setSummaryText(data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‹¤íŒ¨");
                } catch (e) { setSummaryText("Error: " + e.message); }
                setIsSummarizing(false);
            };

            // --- 2. PeerJS Setup (Reconnectable) ---
            const initPeer = () => {
                if (peerRef.current) peerRef.current.destroy();

                let iceServers = [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ];
                if (turnConfig.url) {
                    iceServers.unshift({
                        urls: turnConfig.url,
                        username: turnConfig.username,
                        credential: turnConfig.credential
                    });
                }

                const peer = new Peer({ 
                    config: { iceServers: iceServers },
                    debug: 1
                }); 
                
                setStatus('ì„œë²„ ì—°ê²° ì¤‘...');
                setIsServerConnected(false);

                peer.on('open', (id) => { 
                    setMyId(id); 
                    setStatus('ì¤€ë¹„ë¨ (Ready)'); 
                    setIsServerConnected(true);
                });
                
                peer.on('error', (err) => {
                    console.error("Peer Error:", err);
                    if(err.type === 'peer-unavailable') {
                        setStatus("ì˜¤ë¥˜: ìƒëŒ€ë°© ID ì—†ìŒ");
                        alert("âŒ ìƒëŒ€ë°© IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    } else if(err.type === 'network' || err.type === 'server-error' || err.type === 'socket-error') {
                        setStatus("ì˜¤ë¥˜: ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ë¨");
                        setIsServerConnected(false);
                    } else {
                        setStatus("ì˜¤ë¥˜: " + err.type);
                    }
                });

                peer.on('connection', (conn) => {
                    connRef.current = conn;
                    setupDataConnection(conn);
                });

                peer.on('call', (call) => {
                    setStatus('ì—°ê²° ìš”ì²­ ìˆ˜ì‹ ì¤‘...');
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                        setLocalStream(stream);
                        call.answer(stream);
                        
                        // [ì¶”ê°€] ICE ìƒíƒœ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
                        call.peerConnection.oniceconnectionstatechange = () => {
                            const state = call.peerConnection.iceConnectionState;
                            console.log("ICE State:", state);
                            setMediaStatus(prev => ({...prev, iceStatus: state}));
                            if (state === 'failed' || state === 'disconnected') {
                                alert("âš ï¸ ì—°ê²°ì´ ë°©í™”ë²½ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤ (ICE Failed).\nëª¨ë°”ì¼ í•«ìŠ¤íŒŸì´ë‚˜ TURN ì„œë²„ ì„¤ì •ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
                            }
                        };

                        call.on('stream', (remoteStream) => {
                            setRemoteStream(remoteStream);
                            setMode('call');
                            setStatus('ì—°ê²°ë¨ (Connected)');
                            setIsVideoLoading(true);
                        });
                        callRef.current = call;
                        setupSpeechRecognition();
                    }).catch(e => alert("Media Error: " + e));
                });

                peer.on('disconnected', () => {
                    setStatus('ì„œë²„ì™€ ì—°ê²° ëŠê¹€ (ì¬ì ‘ì† í•„ìš”)');
                    setIsServerConnected(false);
                });

                peerRef.current = peer;
            };

            useEffect(() => {
                initPeer();
                return () => { if(peerRef.current) peerRef.current.destroy(); };
            }, [turnConfig, retryCount]); 

            const setupDataConnection = (conn) => {
                conn.on('data', async (data) => {
                    if (data.type === 'subtitle') {
                        const translated = await translateWithGemini(data.text, myLang);
                        setSubtitles(prev => [...prev, { original: data.text, translated: translated, id: Date.now() }]);
                        speak(translated, myLang);
                    }
                });
                conn.on('open', () => setStatus('ë°ì´í„° ì±„ë„ ì—°ê²°ë¨'));
            };

            const connectToPeer = () => {
                const safeTargetId = targetId.trim();
                
                if (!safeTargetId) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                if (safeTargetId === myId) return alert("ìê¸° ìì‹ ì—ê²ŒëŠ” ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                
                if (!isServerConnected) {
                    return alert("âš ï¸ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'ì¬ì ‘ì†' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                }

                setStatus('ì—°ê²° ì‹œë„ ì¤‘...');
                
                const conn = peerRef.current.connect(safeTargetId);
                if(conn) {
                    connRef.current = conn;
                    setupDataConnection(conn);
                }

                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                    setLocalStream(stream);
                    setMode('call');
                    
                    const call = peerRef.current.call(safeTargetId, stream);
                    
                    // [ì¶”ê°€] ICE ìƒíƒœ ê°ì§€ ë¦¬ìŠ¤ë„ˆ (ë°œì‹ ììš©)
                    call.peerConnection.oniceconnectionstatechange = () => {
                        const state = call.peerConnection.iceConnectionState;
                        setMediaStatus(prev => ({...prev, iceStatus: state}));
                        if (state === 'failed' || state === 'disconnected') {
                            alert("âš ï¸ ì—°ê²°ì´ ë°©í™”ë²½ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤ (ICE Failed).\nëª¨ë°”ì¼ í•«ìŠ¤íŒŸì´ë‚˜ TURN ì„œë²„ ì„¤ì •ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
                        }
                    };

                    call.on('stream', (rs) => { 
                        setRemoteStream(rs); 
                        setStatus('ì—°ê²°ë¨ (Connected)');
                        setIsVideoLoading(true);
                    });
                    call.on('error', (e) => setStatus("Call Error: " + e));
                    callRef.current = call;
                    setupSpeechRecognition();
                }).catch(e => {
                    alert("Media Error: " + e);
                    setStatus('Media Denied');
                });
            };

            // --- 3. STT & TTS ---
            const setupSpeechRecognition = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return;
                recognitionRef.current = new SpeechRecognition();
                recognitionRef.current.continuous = true;
                recognitionRef.current.interimResults = true;
                recognitionRef.current.lang = myLang === 'ko' ? 'ko-KR' : 'en-US';
                recognitionRef.current.onresult = (e) => {
                    let final = '';
                    for (let i = e.resultIndex; i < e.results.length; ++i) {
                        if (e.results[i].isFinal) {
                            final += e.results[i][0].transcript;
                            if (connRef.current?.open) connRef.current.send({ type: 'subtitle', text: final });
                        }
                    }
                };
                recognitionRef.current.start();
            };

            const speak = (text, lang) => {
                if (!window.speechSynthesis || !isTtsEnabled) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang === 'ko' ? 'ko-KR' : 'en-US';
                window.speechSynthesis.speak(u);
            };

            const hangUp = () => { 
                stopEverything();
                window.location.reload(); 
            };

            const safePlay = (videoEl) => {
                if (!videoEl) return;
                const playPromise = videoEl.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        if (error.name === 'AbortError' || error.message.includes('interrupted') || error.message.includes('removed')) {
                            // Ignore
                        } else {
                            console.error('Playback Error:', error);
                        }
                    });
                }
            };

            const refreshVideo = () => {
                if (localStream && localVideoRef.current) {
                    localVideoRef.current.srcObject = localStream;
                    safePlay(localVideoRef.current);
                }
                if (remoteStream && remoteVideoRef.current) {
                    remoteVideoRef.current.srcObject = remoteStream;
                    safePlay(remoteVideoRef.current);
                }
            };

            const testCamera = async () => {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    setLocalStream(null);
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    setLocalStream(stream); 
                } catch (e) {
                    alert("ì¹´ë©”ë¼ë¥¼ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.message);
                }
            };

            const stopCamera = () => {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    setLocalStream(null);
                }
            };

            const manualReconnect = () => {
                setStatus("ì„œë²„ ì¬ì ‘ì† ì¤‘...");
                setRetryCount(prev => prev + 1);
            };

            useEffect(() => {
                if (mode === 'welcome' && localStream && previewVideoRef.current) {
                    previewVideoRef.current.srcObject = localStream;
                    safePlay(previewVideoRef.current);
                }
            }, [localStream, mode]);

            useEffect(() => {
                refreshVideo();
            }, [localStream, remoteStream, mode]);

            // --- Render ---
            if (mode === 'welcome') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="glass-card max-w-md w-full rounded-3xl p-8 text-slate-800 relative animate-slide-up">
                            
                            <button onClick={() => setShowSettings(true)} className="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition-colors" title="ì„¤ì •">
                                <i className="fas fa-cog text-xl"></i>
                            </button>

                            <div className="text-center mb-6">
                                <div className="w-16 h-16 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center text-white text-2xl shadow-lg mb-4"><i className="fas fa-bolt"></i></div>
                                <h1 className="text-2xl font-bold text-slate-900">GlobalMeet AI</h1>
                                
                                <div className="flex flex-col items-center gap-2 mt-2">
                                    {geminiKey && (
                                        <span className="text-[10px] text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-100 flex items-center gap-1">
                                            <i className="fas fa-check-circle"></i> Gemini AI í™œì„±í™”ë¨
                                        </span>
                                    )}
                                    <div className="flex items-center gap-2">
                                        <p className="text-xs text-blue-500 font-mono bg-blue-50 py-1 px-2 rounded inline-block flex items-center gap-2">
                                            <span className={`w-2 h-2 rounded-full ${isServerConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
                                            {status}
                                        </p>
                                        {!isServerConnected && (
                                            <button onClick={manualReconnect} className="text-xs bg-slate-800 text-white px-2 py-1 rounded hover:bg-slate-700 transition">
                                                <i className="fas fa-sync-alt"></i> ì¬ì ‘ì†
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="mb-6">
                                {localStream ? (
                                    <div className="relative w-full aspect-video bg-black rounded-xl overflow-hidden mb-2">
                                        <video ref={previewVideoRef} autoPlay playsInline muted className="w-full h-full object-cover transform scale-x-[-1]" />
                                        <div className="absolute bottom-2 left-2 bg-green-500 text-white text-[10px] px-2 py-1 rounded">ì¹´ë©”ë¼ ì •ìƒ ì‘ë™ ì¤‘</div>
                                        <button onClick={stopCamera} className="absolute top-2 right-2 bg-red-500/80 hover:bg-red-600 text-white text-xs px-2 py-1 rounded shadow transition">
                                            <i className="fas fa-power-off"></i> ë„ê¸°
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={testCamera} className="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-sm font-bold border border-slate-300 mb-2 transition">
                                        ğŸ“¸ ì¹´ë©”ë¼ í…ŒìŠ¤íŠ¸ (ë¯¸ë¦¬ë³´ê¸°)
                                    </button>
                                )}
                            </div>

                            {/* Settings Modal */}
                            {showSettings && (
                                <div className="absolute inset-0 bg-white/95 backdrop-blur-md rounded-3xl z-50 flex flex-col items-center justify-center p-6 animate-fade-in overflow-y-auto">
                                    <h3 className="text-lg font-bold mb-4 w-full">âš™ï¸ ìƒì„¸ ì„¤ì •</h3>
                                    <form onSubmit={saveSettings} className="w-full space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">Gemini API Key</label>
                                            <input name="apiKey" defaultValue={geminiKey} placeholder="AIzaSy..." className="w-full p-2 border rounded-lg bg-slate-50 text-sm" />
                                        </div>
                                        <div className="border-t pt-4">
                                            <label className="block text-xs font-bold text-slate-500 mb-1">TURN Server (ì˜ìƒ ì•ˆ ë‚˜ì˜¬ ë•Œ)</label>
                                            <input name="turnUrl" defaultValue={turnConfig.url} placeholder="turn:..." className="w-full p-2 border rounded-lg bg-slate-50 text-sm mb-2" />
                                            <div className="flex gap-2">
                                                <input name="turnUser" defaultValue={turnConfig.username} placeholder="User" className="w-1/2 p-2 border rounded-lg bg-slate-50 text-sm" />
                                                <input name="turnPass" defaultValue={turnConfig.credential} placeholder="Pass" className="w-1/2 p-2 border rounded-lg bg-slate-50 text-sm" />
                                            </div>
                                        </div>
                                        <div className="flex gap-2 mt-4">
                                            <button type="button" onClick={() => setShowSettings(false)} className="flex-1 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm">ì·¨ì†Œ</button>
                                            <button type="submit" className="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">ì €ì¥</button>
                                        </div>
                                    </form>
                                </div>
                            )}

                            <div className="bg-slate-100 p-4 rounded-xl mb-6 border border-slate-200">
                                <p className="text-xs font-bold text-slate-500 uppercase mb-1">ë‚˜ì˜ ì ‘ì† ì½”ë“œ</p>
                                <div className="flex items-center gap-2">
                                    <span className="font-mono text-lg font-bold text-blue-600 truncate flex-1">{myId || "ìƒì„± ì¤‘..."}</span>
                                    <button onClick={() => { navigator.clipboard.writeText(myId); alert("ë³µì‚¬ë¨"); }} className="p-2 bg-white rounded-lg border hover:bg-slate-50"><i className="fas fa-copy"></i></button>
                                </div>
                            </div>

                            <div className="space-y-4">
                                <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400">ë˜ëŠ”</span></div>
                                <div className="space-y-2">
                                    <input value={targetId} onChange={(e) => setTargetId(e.target.value)} placeholder="ìƒëŒ€ë°© ì½”ë“œ ì…ë ¥" className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none" />
                                    <button onClick={connectToPeer} disabled={!targetId || !myId} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 disabled:opacity-50 shadow-lg flex items-center justify-center gap-2"><i className="fas fa-video"></i> ì—°ê²°í•˜ê¸°</button>
                                </div>
                            </div>
                            
                            <div className="mt-6 border-t border-slate-100 pt-4">
                                <p className="text-xs font-bold text-slate-500 uppercase mb-2 text-center">ë‚˜ì˜ ì–¸ì–´ (ë§í•˜ê³  ë“£ëŠ” ì–¸ì–´)</p>
                                <div className="flex justify-center gap-4 text-sm">
                                    <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition"><input type="radio" name="lang" checked={myLang === 'ko'} onChange={() => setMyLang('ko')} className="accent-blue-600" /> <span className="font-medium">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span></label>
                                    <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition"><input type="radio" name="lang" checked={myLang === 'en'} onChange={() => setMyLang('en')} className="accent-blue-600" /> <span className="font-medium">ğŸ‡ºğŸ‡¸ English</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="relative h-full w-full bg-slate-900 overflow-hidden">
                    {/* Remote Video */}
                    <div className="absolute inset-0 flex items-center justify-center bg-black">
                        
                        {/* [ì¶”ê°€] ì§„ë‹¨ íŒ¨ë„ (ìˆ˜ì •: ICE ìƒíƒœ í‘œì‹œ) */}
                        <div className="absolute top-4 left-4 z-40 flex flex-col gap-2 pointer-events-auto">
                            <button 
                                onClick={() => setShowDiagnostics(!showDiagnostics)} 
                                className="bg-black/50 hover:bg-black/70 text-white px-3 py-1 rounded text-xs backdrop-blur-md self-start border border-white/10"
                            >
                                <i className="fas fa-stethoscope"></i> {showDiagnostics ? "ì§„ë‹¨ ë‹«ê¸°" : "ì§„ë‹¨"}
                            </button>
                            
                            {showDiagnostics && (
                                <div className="bg-black/80 p-3 rounded-lg text-[10px] text-white backdrop-blur-md border border-white/10 w-48 space-y-2">
                                    <div>
                                        <p className="font-bold text-blue-300">ë„¤íŠ¸ì›Œí¬ ìƒíƒœ (ICE)</p>
                                        <p className={mediaStatus.iceStatus === 'connected' ? 'text-green-400 font-bold' : (mediaStatus.iceStatus === 'failed' ? 'text-red-500 font-bold' : 'text-yellow-400')}>{mediaStatus.iceStatus || 'ëŒ€ê¸°ì¤‘'}</p>
                                    </div>
                                    <div className="border-t border-white/20 pt-2">
                                        <p className="font-bold text-purple-300">ë‚´ ìƒíƒœ (Local)</p>
                                        <p>ë¹„ë””ì˜¤: {mediaStatus.localVideo}</p>
                                    </div>
                                    <div className="border-t border-white/20 pt-2">
                                        <p className="font-bold text-purple-300">ìƒëŒ€ë°© ìƒíƒœ (Remote)</p>
                                        <p>ë¹„ë””ì˜¤: {mediaStatus.remoteVideo}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        {remoteStream ? (
                            <video 
                                ref={remoteVideoRef} 
                                autoPlay 
                                playsInline 
                                className="w-full h-full object-cover"
                                onLoadedMetadata={(e) => safePlay(e.target)} 
                            />
                        ) : (
                            <div className="text-center animate-pulse text-white/50 flex flex-col items-center">
                                <div className="text-4xl mb-3"><i className="fas fa-spinner fa-spin"></i></div>
                                <p className="text-lg font-bold mb-1">
                                    {isVideoLoading ? "ì˜ìƒ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘..." : "ì—°ê²° ì¤‘..."}
                                </p>
                                <p className="text-xs text-slate-400 max-w-xs">
                                    ìƒëŒ€ë°© ì¹´ë©”ë¼ ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.<br/>
                                    (í™”ë©´ì´ ê³„ì† ì•ˆ ë‚˜ì˜¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”)
                                </p>
                            </div>
                        )}
                        
                        <button 
                            onClick={refreshVideo} 
                            className="absolute top-1/2 left-1/2 transform -translate-x-1/2 translate-y-16 bg-white/10 hover:bg-white/20 backdrop-blur px-5 py-2 rounded-full text-xs text-white border border-white/20 transition z-30 flex items-center gap-2 shadow-lg"
                        >
                            <i className="fas fa-sync-alt"></i> ì˜ìƒ ì¬ì—°ê²° (ê°•ì œ ìƒˆë¡œê³ ì¹¨)
                        </button>
                    </div>

                    <div className="absolute bottom-32 left-0 right-0 px-6 flex flex-col items-center pointer-events-none z-10">
                        {subtitles.slice(-1).map(sub => (
                            <div key={sub.id} className="animate-slide-up max-w-3xl w-full">
                                <div className="glass-bar px-8 py-6 rounded-2xl text-center border border-white/20 shadow-2xl">
                                    <p className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-400 drop-shadow-sm leading-relaxed">{sub.translated}</p>
                                    <p className="text-sm text-slate-400 mt-2 font-medium tracking-wide">{sub.original}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="absolute top-6 right-6 w-48 aspect-[4/3] bg-black rounded-2xl overflow-hidden shadow-2xl border border-white/20 z-20">
                        <video 
                            ref={localVideoRef} 
                            autoPlay 
                            playsInline 
                            muted 
                            className={`w-full h-full object-cover transform scale-x-[-1] ${isVideoOff ? 'hidden' : ''}`} 
                            onLoadedMetadata={(e) => safePlay(e.target)}
                        />
                        {isVideoOff && <div className="w-full h-full flex items-center justify-center bg-slate-800"><i className="fas fa-video-slash text-white/30 text-2xl"></i></div>}
                    </div>

                    <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 z-20">
                        <div className="glass-bar flex items-center gap-2 p-2 rounded-full shadow-2xl">
                            <button onClick={() => { localStream.getAudioTracks().forEach(t => t.enabled = !t.enabled); setIsMuted(!isMuted); }} className={`w-14 h-14 rounded-full flex items-center justify-center text-xl transition ${isMuted ? 'bg-red-500' : 'hover:bg-white/10'}`}><i className={`fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}`}></i></button>
                            <button onClick={() => { localStream.getVideoTracks().forEach(t => t.enabled = !t.enabled); setIsVideoOff(!isVideoOff); }} className={`w-14 h-14 rounded-full flex items-center justify-center text-xl transition ${isVideoOff ? 'bg-red-500' : 'hover:bg-white/10'}`}><i className={`fas ${isVideoOff ? 'fa-video-slash' : 'fa-video'}`}></i></button>
                            <button onClick={() => { if (isTtsEnabled) window.speechSynthesis.cancel(); setIsTtsEnabled(!isTtsEnabled); }} className={`w-14 h-14 rounded-full flex items-center justify-center text-xl transition ${!isTtsEnabled ? 'bg-slate-600' : 'bg-white text-black'}`}><i className={`fas ${isTtsEnabled ? 'fa-volume-up' : 'fa-volume-mute'}`}></i></button>
                            <button onClick={generateSummary} className="w-14 h-14 rounded-full flex items-center justify-center text-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white transition hover:scale-105 shadow-lg shadow-purple-500/30"><i className="fas fa-magic"></i></button>
                            <div className="w-px h-8 bg-white/20 mx-1"></div>
                            <button onClick={hangUp} className="w-14 h-14 rounded-full flex items-center justify-center text-xl bg-red-600 hover:bg-red-700 transition"><i className="fas fa-phone-slash"></i></button>
                        </div>
                    </div>

                    {showSummary && (
                        <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden text-slate-800 shadow-2xl">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50"><h3 className="font-bold text-lg"><i className="fas fa-file-alt text-blue-600 mr-2"></i>AI ìš”ì•½</h3><button onClick={() => setShowSummary(false)}><i className="fas fa-times"></i></button></div>
                                <div className="p-6 overflow-y-auto flex-1 prose-sm">{isSummarizing ? <div className="text-center py-4 text-slate-500">ìš”ì•½ ìƒì„± ì¤‘...</div> : <div className="whitespace-pre-line">{summaryText}</div>}</div>
                                <div className="p-4 border-t bg-slate-50 flex justify-end"><button onClick={() => { navigator.clipboard.writeText(summaryText); alert("ë³µì‚¬ë¨"); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">ë³µì‚¬</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
